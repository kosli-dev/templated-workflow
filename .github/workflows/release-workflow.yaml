name: Reusable Release Workflow

on:
    workflow_dispatch: 
        inputs:
            docker-image:
                description: 'Docker image to use'
                required: true
                type: string
    workflow_call:
        inputs:
            docker-image:
                description: 'Docker image to use'
                required: true
                type: string

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            - name: echo release
              run: echo "Releasing ${{ inputs.docker-image }}"
            - name: setup-kosli-cli
              uses: kosli-dev/setup-cli-action@v2
            - name: Download container image
              run: docker pull ${{ inputs.docker-image }}
            - name: Get trail from Kosli
              env:
                IMAGE: ${{ inputs.docker-image }}
              id: get_trail # Assign an ID to this step to reference its outputs
              uses: actions/github-script@v7
              with:
                script: |
                  const { execSync } = require('child_process');
                  const fingerprint = execSync(`kosli fingerprint --artifact-type=docker $IMAGE`, { encoding: 'utf-8' });
                  execSync(`kosli search ${fingerprint} -o json > data.json`, { encoding: 'utf-8' });
                  const trail = execSync(`jq -r '.artifacts[0].trail' < data.json`, { encoding: 'utf-8' });
                  execSync(`kosli get trail -o json ${fingerprint} > trail.json`, { encoding: 'utf-8' });
            - name: check trail complete
              run: bash check-template-complete.sh trail.json MISSING